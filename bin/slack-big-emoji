#!/usr/bin/env ruby
require_relative '../lib/slack_big_emoji'

cli = SlackBigEmoji::CLI.new(ARGV)
emoji = SlackBigEmoji::Converter.new(cli.options)
unless emoji.valid?
  if emoji.output_ext == 'gif' && (emoji.frame_width != emoji.canvas_width || emoji.frame_height != emoji.canvas_height)
    abort "Image must be square (width == height). Detected canvas #{emoji.canvas_width}x#{emoji.canvas_height} (ratio #{format('%.4f', emoji.ratio)}); first-frame #{emoji.frame_width}x#{emoji.frame_height} (GIFs may store trimmed frames on a larger square canvas)."
  end
  abort "Image must be square (width == height). Detected #{emoji.width}x#{emoji.height} (ratio #{format('%.4f', emoji.ratio)})."
end

cli.log "File Info"
cli.log "--------------"
cli.log "File name", emoji.file_name
cli.log "Ratio", emoji.ratio
cli.log "File Resize Spec", emoji.file_resize_spec
cli.log ""
cli.log "Options"
cli.log "--------------"
cli.log "Tile Width", emoji.tile_width
cli.log "Crop Size", emoji.crop_size
cli.log ""
cli.log "CLI Options"
cli.log "--------------"
cli.options.each do |option, value|
  cli.log "#{option}", value
end

cli.log ""
cli.log "Converting"
cli.log "--------------"
cli.log "Temp Input", emoji.image.path
cli.log "Output Dir", emoji.output_dir
cli.log "Output Path", emoji.output_path
begin
  emoji.convert
rescue SlackBigEmoji::ConversionError => e
  abort e.message
end
cli.log "Done", "Yes"

unless cli.options[:convert_only]
  abort "Uploading is no longer supported (mechanize dependency removed). Re-run with -c/--convert-only."
end

cli.log ""
cli.log "Emoji Grid"
cli.log "--------------"
cli.emoji_grid(emoji.output_filename)
